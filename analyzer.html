<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crop Recommendation Data</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- SimpleKeyboard CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-keyboard/build/css/index.css">
    <!-- SimpleKeyboard JS -->
    <script src="https://cdn.jsdelivr.net/npm/simple-keyboard/build/index.js"></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("W1oLjHvR76SBkSAuV");
        })();

        // Crop Names Mapping (English to Filipino)
        const cropNamesFilipino = {
            "barley": "Barley",
            "sunflower": "Sunflower",
            "sweetpotato": "Kamote",
            "rice": "Bigas",
            "soybean": "Soybeans",
            "jowar": "Great Millet",
            "potato": "Patatas",
            "turmeric": "Luyang Dilaw",
            "jute": "Saluyot",
            "maize": "Mais",
            "moong": "Munggo",
            "onion": "Sibuyas",
            "cabbage": "Repolyo",
            "ragi": "Kabog Millet",
            "banana": "Saging",
            "rapeseed": "Rapeseed",
            "wheat": "Trigo",
            "horsegram": "Kulangot",
            "coriander": "Cilantro",
            "mango": "Mangga",
            "tomato": "Kamatis",
            "cotton": "Bulak",
            "brinjal": "Talong",
            "garlic": "Bawang",
            "blackgram": "Urad/Vigna Munggo",
            "cardamom": "Kardamomo",
            "blackpepper": "Paminta",
            "orange": "Orange",
            "bittergourd": "Ampalaya",
            "papaya": "Papaya",
            "grapes": "Ubas",
            "ladyfinger": "Okra",
            "pineapple": "Pinya",
            "bottlegourd": "Upo",
            "jackfruit": "Langka",
            "pumpkin": "Kalabasa",
            "cauliflower": "Cauliflower",
            "cucumber": "Pipino",
            "drumstick": "Malunggay",
            "radish": "Labanos"
        };

        // Flag to prevent toggle issues
        let keyboardToggleInProgress = false;

        function sendEmail() {
            const userEmail = document.getElementById("emailInput").value;
            const cropData = document.getElementById("data-container").innerText;
            const currentTime = new Date().toLocaleString();

            if (!userEmail) {
                document.getElementById("emailStatus").innerHTML = "<span class='error'>❌ Please enter a valid email address.</span>";
                return;
            }

            const templateParams = {
                from_name: "Crop Assistant",
                message: cropData,
                reply_to: userEmail,
                email: userEmail,
                time: currentTime
            };

            emailjs.send("MaglulupaNiJulie", "contact_form", templateParams)
                .then(function(response) {
                    document.getElementById("emailStatus").innerHTML = "<span style='color:green;'>✅ Email sent successfully!</span>";
                    document.getElementById("emailInput").value = "";
                    setTimeout(() => {
                        document.getElementById("emailStatus").innerHTML = "";
                    }, 3000);
                }, function(error) {
                    document.getElementById("emailStatus").innerHTML = "<span class='error'>❌ Failed to send email. Please try again.</span>";
                });
        }

        async function fetchData() {
            const url = "https://croprecommendationmodel.onrender.com/"; 
            
            try {
                document.getElementById("data-container").innerHTML = "<span class='loading'> Fetching data...</span>";
                const response = await fetch(url);

                if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);
                const data = await response.json();

                const { nitrogen, phosphorus, potassium, temperature, rainfall, soilPH } = data.latest_data;

                const cropRecommendations = data.top_3_recommendations.map((rec, index) => {
                    const cropNameFilipino = cropNamesFilipino[rec.crop.toLowerCase()] || rec.crop;
                    return ` <strong>${index + 1}. ${cropNameFilipino.toUpperCase()}</strong> - Confidence: ${rec.confidence}%`;
                }).join("<br>");

                document.getElementById("data-container").innerHTML = ` 
                    <strong> Status:</strong> ${data.message} <br>
                    <strong> Data:</strong> <br>
                    <strong> Nitrogen:</strong> ${nitrogen.toFixed(2)} mg/kg<br>
                    <strong> Phosphorus:</strong> ${phosphorus.toFixed(2)} mg/kg<br>
                    <strong> Potassium:</strong> ${potassium.toFixed(2)} mg/kg<br>
                    <strong> Temperature:</strong> ${temperature.toFixed(2)}°C <br>
                    <strong> Rainfall:</strong> ${rainfall.toFixed(2)} mm <br>
                    <strong> Soil pH:</strong> ${soilPH.toFixed(2)}<br><br>
                    <strong> Top 3 Crop Recommendations:</strong><br>
                    ${cropRecommendations}
                `;
            } catch (error) {
                document.getElementById("data-container").innerHTML = `<span class="error">❌ Failed to load data. Check API connection.</span>`;
            }
        }

        async function clearData() {
            const googleAppScriptUrl = "https://script.google.com/macros/s/AKfycbxgMCvg0dApIL3FVQRpvelIHJd6KlvPgrTkN883m8ctU02_Kt51DW0ZQGxwcoOZhkUW/exec";
            try {
                document.getElementById("refreshButton").disabled = true;
                document.getElementById("data-container").innerHTML = "<span class='loading'> Data cleared successfully.</span>";

                setTimeout(() => {
                    document.getElementById("data-container").innerHTML = "<span class='loading'> Sensor resetting, wait for <span id='countdown'>2:00</span> before refreshing.</span>";
                    startCountdown(120);
                }, 2000);

                await fetch(googleAppScriptUrl, { method: 'GET' });
            } catch (error) {
                document.getElementById("data-container").innerHTML = `<span class="error">❌ Failed to clear data. Check Apps Script connection.</span>`;
            }
        }

        function startCountdown(seconds) {
            let countdown = seconds;
            const countdownDisplay = document.getElementById('countdown');

            const countdownInterval = setInterval(() => {
                const minutes = Math.floor(countdown / 60);
                const remainingSeconds = countdown % 60;
                countdownDisplay.innerHTML = `${minutes}:${remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds}`;

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById("refreshButton").disabled = false;
                    document.getElementById("data-container").innerHTML = "<span class='loading'>✅ Finished, you can refresh now</span>";
                }

                countdown--;
            }, 1000);
        }

        function goBack() {
            window.location.href = "air-drying.html";
        }

        function goHome() {
            window.location.href = "index.html";
        }

        // Initialize data fetch on page load
        document.addEventListener("DOMContentLoaded", function() {
            fetchData();
            
            // Virtual Keyboard Implementation
            let keyboard;
            let currentInputTarget = null;
            
            keyboard = new SimpleKeyboard.default({
                onChange: input => {
                    if (currentInputTarget) {
                        currentInputTarget.value = input;
                        
                        // Update the preview text when typing
                        updateInputPreview(currentInputTarget);
                    }
                },
                onKeyPress: button => {
                    if (button === "{enter}") {
                        if (currentInputTarget === document.getElementById("emailInput")) {
                            sendEmail();
                        }
                        hideKeyboard();
                    }
                    if (button === "{bksp}") {
                        if (currentInputTarget) {
                            const newValue = currentInputTarget.value.slice(0, -1);
                            currentInputTarget.value = newValue;
                            keyboard.setInput(newValue);
                            
                            // Update the preview after deleting
                            updateInputPreview(currentInputTarget);
                        }
                    }
                    if (button === "{space}") {
                        if (currentInputTarget) {
                            const newValue = currentInputTarget.value + " ";
                            currentInputTarget.value = newValue;
                            keyboard.setInput(newValue);
                            
                            // Update the preview after space
                            updateInputPreview(currentInputTarget);
                        }
                    }
                },
                layout: {
                    default: [
                        "1 2 3 4 5 6 7 8 9 0 - =",
                        "q w e r t y u i o p [ ]",
                        "a s d f g h j k l ; '",
                        "z x c v b n m , . /",
                        "{shift} @ # $ % & * ( ) _",
                        "{space} {bksp} {enter}"
                    ],
                    shift: [
                        "! @ # $ % ^ & * ( ) _ +",
                        "Q W E R T Y U I O P { }",
                        "A S D F G H J K L : \"",
                        "Z X C V B N M < > ?",
                        "{default} ~ ` | \\ [ ] { }",
                        "{space} {bksp} {enter}"
                    ]
                },
                display: {
                    "{bksp}": "⌫ Del",
                    "{enter}": "↵ Enter",
                    "{space}": "Space",
                    "{shift}": "⇧ Shift",
                    "{default}": "ABC"
                },
                buttonTheme: [
                    {
                        class: "special-button",
                        buttons: "{shift} {enter} {bksp} {space}"
                    }
                ],
                physicalKeyboardHighlight: false,
                syncInstanceInputs: true,
                mergeDisplay: true,
                theme: "hg-theme-default"
            });

            // Show keyboard on focus for all text inputs
            document.addEventListener("click", (e) => {
                if (e.target.matches("input[type='text'], input[type='email']")) {
                    currentInputTarget = e.target;
                    showKeyboard();
                    keyboard.setInput(e.target.value);
                    
                    // Show the preview element when input is focused
                    showInputPreview(e.target);
                } else if (!e.target.closest(".simple-keyboard-container") && 
                           !e.target.classList.contains("keyboard-toggle")) {
                    hideKeyboard();
                    hideInputPreview();
                }
            });

            const emailInput = document.getElementById("emailInput");
            // Prevent default touch behavior to avoid double-click issues
            emailInput.addEventListener("touchstart", (e) => {
                e.preventDefault();
                currentInputTarget = emailInput;
                showKeyboard();
                keyboard.setInput(emailInput.value);
                
                // Show preview on touch
                showInputPreview(emailInput);
            });
            
            // Regular keyboard input handling
            emailInput.addEventListener("input", function(e) {
                updateInputPreview(e.target);
            });
            
            // Initialize keyboard toggle button
            document.querySelector(".keyboard-toggle").addEventListener("click", toggleKeyboard);
            
            // Create a preview element for inputs
            createInputPreviewElement();
        });

        function showKeyboard() {
            if (keyboardToggleInProgress) return;
            
            const keyboardContainer = document.getElementById("keyboard-container");
            keyboardContainer.style.display = "block";
            // Add a small delay before adding the animation class
            setTimeout(() => {
                keyboardContainer.classList.add("keyboard-show");
            }, 10);
        }

        function hideKeyboard() {
            if (keyboardToggleInProgress) return;
            
            const keyboardContainer = document.getElementById("keyboard-container");
            keyboardContainer.classList.remove("keyboard-show");
            setTimeout(() => {
                keyboardContainer.style.display = "none";
            }, 300);
            currentInputTarget = null;
            
            // Hide preview when keyboard is hidden
            hideInputPreview();
        }

        function toggleKeyboard() {
            if (keyboardToggleInProgress) return;
            
            keyboardToggleInProgress = true;
            const keyboardContainer = document.getElementById("keyboard-container");
            
            if (keyboardContainer.style.display === "none" || !keyboardContainer.style.display || 
                !keyboardContainer.classList.contains("keyboard-show")) {
                showKeyboard();
                setTimeout(() => {
                    keyboardToggleInProgress = false;
                }, 400);
            } else {
                hideKeyboard();
                setTimeout(() => {
                    keyboardToggleInProgress = false;
                }, 400);
            }
        }
        
        // Create a preview element for text input
        function createInputPreviewElement() {
            if (!document.getElementById('input-preview')) {
                const previewEl = document.createElement('div');
                previewEl.id = 'input-preview';
                previewEl.className = 'input-preview';
                previewEl.style.display = 'none';
                document.body.appendChild(previewEl);
            }
        }
        
        // Show the preview element
        function showInputPreview(inputElement) {
            const previewEl = document.getElementById('input-preview');
            if (previewEl) {
                // Position the preview above the input
                const rect = inputElement.getBoundingClientRect();
                previewEl.style.top = (rect.top - 40) + 'px';
                previewEl.style.left = rect.left + 'px';
                previewEl.style.width = rect.width + 'px';
                previewEl.style.display = 'block';
                
                // Initial text
                updateInputPreview(inputElement);
            }
        }
        
        // Hide the preview element
        function hideInputPreview() {
            const previewEl = document.getElementById('input-preview');
            if (previewEl) {
                previewEl.style.display = 'none';
            }
        }
        
        // Update the preview text content
        function updateInputPreview(inputElement) {
            const previewEl = document.getElementById('input-preview');
            if (previewEl && inputElement) {
                const value = inputElement.value;
                
                // Show the current text or placeholder if empty
                if (value) {
                    previewEl.textContent = value;
                    previewEl.classList.add('active');
                } else {
                    previewEl.textContent = inputElement.placeholder || 'Type here...';
                    previewEl.classList.remove('active');
                }
            }
        }
    </script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
        font-size: 18px;
    }

    body {
        background: #f1f8e9;
        color: #2e2e2e;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        padding: 10px;
    }

    .app-container {
        width: 600px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0px 5px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .title-bar {
        background-color: #7b9b3a;
        color: white;
        padding: 20px;
        font-size: 26px;
        text-align: center;
        font-weight: 600;
    }

    .title-bar::before {
        content: '🌾';
        margin-right: 10px;
        font-size: 28px;
    }

    .content {
        padding: 20px;
    }

    button {
        background: #7b9b3a;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px;
    }

    button:hover {
        background: #6a8c33;
    }

    button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .button-container {
        display: flex;
        justify-content: center;
        gap: 2px;
    }

    #data-container {
        background: #eaf6e1;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.05);
        line-height: 1.5;
        text-align: left;
        color: #333;
        margin-top: 10px;
    }

    .error {
        color: red;
        font-weight: bold;
    }

    .loading {
        color: #555;
        font-style: italic;
    }

    strong {
        color: #6a8c33;
    }

    .back-button-container {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 15px;
    }

    .back-button-container button {
        background: #c5e1a5;
        height: 80px;
        color: #33691e;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    .back-button-container button:hover {
        background: #aed581;
    }

    .email-container {
        display: flex;
        align-items: center;
        position: relative;
    }
    
    .emailtext {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .sendEmail {
        height: 45px;
        display: flex;
        align-items: center;
    }

    /* Input styling with hover effects */
    #emailInput {
        padding: 10px;
        width: 70%;
        max-width: 400px;
        border-radius: 6px;
        border: 2px solid #ccc;
        font-size: 16px;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
    }

    #emailInput:hover, #emailInput:focus {
        border-color: #7b9b3a;
        box-shadow: 0 0 8px rgba(123, 155, 58, 0.4);
    }

    /* Input preview element styling */
    .input-preview {
        position: absolute;
        background: #f5fbef;
        border: 1px solid #7b9b3a;
        border-radius: 6px;
        padding: 8px 12px;
        color: #555;
        font-size: 16px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        text-align: center;
        transition: all 0.2s ease;
        font-style: italic;
    }

    .input-preview.active {
        background: #e8f5e9;
        color: #2e7d32;
        font-style: normal;
        font-weight: 500;
    }
        
    /* Virtual Keyboard Styles */
    .simple-keyboard-container {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 90%;
        max-width: 800px;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 12px 12px 0 0;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none;
        transition: transform 0.3s ease-in-out;
        padding: 15px;
    }

    .simple-keyboard-container.keyboard-show {
        transform: translateX(-50%) translateY(0);
    }

    .simple-keyboard {
        font-family: 'Poppins', sans-serif;
    }

    .simple-keyboard .hg-button {
        height: 50px;
        min-width: 40px;
        font-size: 18px;
        background: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        margin: 3px;
    }

    .simple-keyboard .hg-button:hover {
        background: #7b9b3a;
        color: white;
        transform: scale(1.05);
    }

    .simple-keyboard .hg-button:active {
        transform: scale(0.98);
    }

    .simple-keyboard .hg-button.special-button {
        background: #e8f5e9;
        color: #2e7d32;
        font-weight: 600;
    }

    .simple-keyboard .hg-button.special-button:hover {
        background: #6a8c33;
        color: white;
    }

    .simple-keyboard .hg-button[data-button="{space}"] {
        min-width: 200px;
    }

    .simple-keyboard .hg-button[data-button="{enter}"] {
        background: #7b9b3a;
        color: white;
        min-width: 100px;
    }

    .simple-keyboard .hg-button[data-button="{bksp}"] {
        background: #ff9800;
        color: white;
        min-width: 80px;
    }

    /* Typing indicator animation */
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0; }
    }

    .typing-indicator {
        display: inline-block;
        width: 10px;
        height: 20px;
        background-color: #7b9b3a;
        margin-left: 5px;
        vertical-align: middle;
        animation: blink 1s infinite;
    }

    /* Fixed keyboard toggle button */
    .keyboard-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background: #7b9b3a;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 1001; /* Above the keyboard */
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        transition: transform 0.2s, background-color 0.2s;
    }

    .keyboard-toggle:hover {
        background: #6a8c33;
        transform: scale(1.1);
    }

</style>
</head>
<body>
    <div class="app-container">
        <div class="title-bar">
            Crop Recommendation Data
        </div>

        <div class="back-button-container">
            <button onclick="goHome()">🏠 Go to Home</button>
            <button onclick="goBack()">🔙 Back</button>
        </div>

        <div class="content">
            <div class="button-container">
                <button id="refreshButton" onclick="fetchData()">🔄 Refresh Data</button>
                <button onclick="clearData()">🧹 Clear Data</button>
            </div>

            <div id="data-container">
                <span class="loading">⏳ Loading data...</span>
            </div>

            <hr style="margin: 20px 0;">
            <div class="emailtext">
                <label for="emailInput"><strong>📧 Send data to your email:</strong></label><br>
            </div>
            
            <div class="email-container">
                <input type="email" id="emailInput" placeholder="Enter your email"
                    style="padding: 10px; width: 70%; max-width: 400px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; text-align: center;">
                <button class="sendEmail" onclick="sendEmail()" style="background: #558b2f; width: 200px;">📧 Send Data</button>
                <div id="emailStatus" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>

    <!-- Virtual Keyboard Container -->
    <div id="keyboard-container" class="simple-keyboard-container">
        <div class="simple-keyboard"></div>
    </div>

    <!-- Fixed Keyboard Toggle Button -->
    <button class="keyboard-toggle">⌨️</button>

</body>
</html>