<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crop Recommendation Data</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("W1oLjHvR76SBkSAuV");
        })();

        // Crop Names Mapping (English to Filipino)
        const cropNamesFilipino = {
            "barley": "Barley",
            "sunflower": "Sunflower",
            "sweetpotato": "Kamote",
            "rice": "Bigas",
            "soybean": "Soybeans",
            "jowar": "Great Millet",
            "potato": "Patatas",
            "turmeric": "Luyang Dilaw",
            "jute": "Saluyot",
            "maize": "Mais",
            "moong": "Munggo",
            "onion": "Sibuyas",
            "cabbage": "Repolyo",
            "ragi": "Kabog Millet",
            "banana": "Saging",
            "rapeseed": "Rapeseed",
            "wheat": "Trigo",
            "horsegram": "Kulangot",
            "coriander": "Cilantro",
            "mango": "Mangga",
            "tomato": "Kamatis",
            "cotton": "Bulak",
            "brinjal": "Talong",
            "garlic": "Bawang",
            "blackgram": "Urad/Vigna Munggo",
            "cardamom": "Kardamomo",
            "blackpepper": "Paminta",
            "orange": "Orange",
            "bittergourd": "Ampalaya",
            "papaya": "Papaya",
            "grapes": "Ubas",
            "ladyfinger": "Okra",
            "pineapple": "Pinya",
            "bottlegourd": "Upo",
            "jackfruit": "Langka",
            "pumpkin": "Kalabasa",
            "cauliflower": "Cauliflower",
            "cucumber": "Pipino",
            "drumstick": "Malunggay",
            "radish": "Labanos"
        };

        function sendEmail() {
            const userEmail = document.getElementById("emailInput").value;
            const cropData = document.getElementById("data-container").innerText;
            const currentTime = new Date().toLocaleString();

            if (!userEmail) {
                document.getElementById("emailStatus").innerHTML = "<span class='error'>‚ùå Please enter a valid email address.</span>";
                return;
            }

            const templateParams = {
                from_name: "Crop Assistant",
                message: cropData,
                reply_to: userEmail,
                email: userEmail,
                time: currentTime
            };

            emailjs.send("MaglulupaNiJulie", "contact_form", templateParams)
                .then(function(response) {
                    document.getElementById("emailStatus").innerHTML = "<span style='color:green;'>‚úÖ Email sent successfully!</span>";
                    document.getElementById("emailInput").value = "";
                    setTimeout(() => {
                        document.getElementById("emailStatus").innerHTML = "";
                    }, 3000);
                }, function(error) {
                    document.getElementById("emailStatus").innerHTML = "<span class='error'>‚ùå Failed to send email. Please try again.</span>";
                });
        }

        async function fetchData() {
            const url = "https://croprecommendationmodel.onrender.com/"; 
            
            try {
                document.getElementById("data-container").innerHTML = "<span class='loading'> Fetching data...</span>";
                const response = await fetch(url);

                if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);
                const data = await response.json();

                const { nitrogen, phosphorus, potassium, temperature, rainfall, soilPH } = data.latest_data;

                const cropRecommendations = data.top_3_recommendations.map((rec, index) => {
                    const cropNameFilipino = cropNamesFilipino[rec.crop.toLowerCase()] || rec.crop;
                    return ` <strong>${index + 1}. ${cropNameFilipino.toUpperCase()}</strong> - Confidence: ${rec.confidence}%`;
                }).join("<br>");

                document.getElementById("data-container").innerHTML = ` 
                    <strong> Status:</strong> ${data.message} <br>
                    <strong> Data:</strong> <br>
                    <strong> Nitrogen:</strong> ${nitrogen.toFixed(2)} mg/kg<br>
                    <strong> Phosphorus:</strong> ${phosphorus.toFixed(2)} mg/kg<br>
                    <strong> Potassium:</strong> ${potassium.toFixed(2)} mg/kg<br>
                    <strong> Temperature:</strong> ${temperature.toFixed(2)}¬∞C <br>
                    <strong> Rainfall:</strong> ${rainfall.toFixed(2)} mm <br>
                    <strong> Soil pH:</strong> ${soilPH.toFixed(2)}<br><br>
                    <strong> Top 3 Crop Recommendations:</strong><br>
                    ${cropRecommendations}
                `;
            } catch (error) {
                document.getElementById("data-container").innerHTML = `<span class="error">‚ùå Failed to load data. Check API connection.</span>`;
            }
        }

        async function clearData() {
            const googleAppScriptUrl = "https://script.google.com/macros/s/AKfycbxgMCvg0dApIL3FVQRpvelIHJd6KlvPgrTkN883m8ctU02_Kt51DW0ZQGxwcoOZhkUW/exec";
            try {
                document.getElementById("refreshButton").disabled = true;
                document.getElementById("data-container").innerHTML = "<span class='loading'> Data cleared successfully.</span>";

                setTimeout(() => {
                    document.getElementById("data-container").innerHTML = "<span class='loading'> Sensor resetting, wait for <span id='countdown'>2:00</span> before refreshing.</span>";
                    startCountdown(120);
                }, 2000);

                await fetch(googleAppScriptUrl, { method: 'GET' });
            } catch (error) {
                document.getElementById("data-container").innerHTML = `<span class="error">‚ùå Failed to clear data. Check Apps Script connection.</span>`;
            }
        }

        function startCountdown(seconds) {
            let countdown = seconds;
            const countdownDisplay = document.getElementById('countdown');

            const countdownInterval = setInterval(() => {
                const minutes = Math.floor(countdown / 60);
                const remainingSeconds = countdown % 60;
                countdownDisplay.innerHTML = `${minutes}:${remainingSeconds < 10 ? '0' + remainingSeconds : remainingSeconds}`;

                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById("refreshButton").disabled = false;
                    document.getElementById("data-container").innerHTML = "<span class='loading'>‚úÖ Finished, you can refresh now</span>";
                }

                countdown--;
            }, 1000);
        }

        function goBack() {
            window.location.href = "air-drying.html";
        }

        function goHome() {
            window.location.href = "index.html";
        }

        fetchData();
    </script>

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
        font-size: 18px;
    }

    body {
        background: #f1f8e9;
        color: #2e2e2e;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        padding: 20px;
    }

    .app-container {
        width: 600px;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0px 5px 20px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .title-bar {
        background-color: #7b9b3a;
        color: white;
        padding: 20px;
        font-size: 26px;
        text-align: center;
        font-weight: 600;
    }

    .title-bar::before {
        content: 'üåæ';
        margin-right: 10px;
        font-size: 28px;
    }

    .content {
        padding: 30px;
    }

    button {
        background: #7b9b3a;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px;
    }

    button:hover {
        background: #6a8c33;
    }

    button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .button-container {
        display: flex;
        justify-content: center;
        gap: 25px;
    }

    #data-container {
        background: #eaf6e1;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.05);
        line-height: 1.8;
        text-align: left;
        color: #333;
        margin-top: 20px;
    }

    .error {
        color: red;
        font-weight: bold;
    }

    .loading {
        color: #555;
        font-style: italic;
    }

    strong {
        color: #6a8c33;
    }

    .back-button-container {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 15px;
    }

    .back-button-container button {
        background: #c5e1a5;
        color: #33691e;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }

    .back-button-container button:hover {
        background: #aed581;
    }

    .email-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 20px;
    }
</style>
</head>
<body>

    <div class="app-container">
        <div class="title-bar">
            Crop Recommendation Data
        </div>

        <div class="back-button-container">
            <button onclick="goHome()">üè† Go to Home</button>
            <button onclick="goBack()">üîô Back</button>
        </div>

        <div class="content">
            <div class="button-container">
                <button id="refreshButton" onclick="fetchData()">üîÑ Refresh Data</button>
                <button onclick="clearData()">üßπ Clear Data</button>
            </div>

            <div id="data-container">
                <span class="loading">‚è≥ Loading data...</span>
            </div>

            <hr style="margin: 20px 0;">
            <div class="email-container">
                <label for="emailInput"><strong>üìß Send data to your email:</strong></label><br>
                <input type="email" id="emailInput" placeholder="Enter your email"
                    style="padding: 10px; width: 80%; max-width: 400px; margin-top: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; text-align: center;">
                <button onclick="sendEmail()" style="margin-top: 15px; background: #558b2f; width: 200px;">‚úâÔ∏è Send Data</button>
                <div id="emailStatus" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>

</body>
</html>
