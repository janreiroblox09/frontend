<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ESP32 Motor Control Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2285%22>‚öôÔ∏è</text></svg>">
  <style>
    /* Same CSS styling as before (unchanged) */
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f1f8e9;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .container {
      background: #fff;
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 800px;
      width: 90%;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 20px;
      color: #33691e;
    }
    .status {
      margin-bottom: 20px;
      font-size: 1.2rem;
    }
    button {
      font-size: 1.2rem;
      padding: 14px 30px;
      margin: 10px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.3s;
    }
    .on-btn {
      background-color: #7cb342;
      color: #fff;
    }
    .off-btn {
      background-color: #e53935;
      color: #fff;
    }
    .on-btn:hover {
      background-color: #689f38;
    }
    .off-btn:hover {
      background-color: #c62828;
    }
    .progress-bar {
      margin-top: 20px;
      width: 100%;
    }
    progress {
      width: 100%;
      height: 20px;
      border-radius: 10px;
      appearance: none;
    }
    progress::-webkit-progress-bar {
      background-color: #e0e0e0;
      border-radius: 10px;
    }
    progress::-webkit-progress-value {
      background-color: #7cb342;
      border-radius: 10px;
    }
    .time-display, .final-message {
      margin-top: 20px;
      font-size: 1.2rem;
      font-weight: bold;
    }
    .scanning-log {
      font-size: 1rem;
      color: #555;
      margin-top: 10px;
      height: 40px;
      overflow-y: auto;
      text-align: center;
      background: #f9fbe7;
      padding: 10px;
      border-radius: 10px;
      width: 100%;
      margin-bottom: 20px;
    }
    .top-buttons {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 20px;
    }
    .back-btn {
      padding: 12px 24px;
      background-color: #aed581;
      color: #33691e;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .back-btn:hover {
      background-color: #9ccc65;
    }
    .reset-btn {
      background-color: #fbc02d;
      color: #000;
    }
    .reset-btn:hover {
      background-color: #f9a825;
    }
  </style>
</head>
<body>
  <div class="top-buttons">
    <button class="back-btn" onclick="goBack()">üîô Back</button>
  </div>
  <div class="container">
    <h1>ESP32 Motor Control Panel</h1>
    <div class="status" id="motorStatus">üîç Scanning for ESP32...</div>
    <div class="scanning-log" id="scanLog"></div>

    <button class="on-btn" onclick="controlMotor('on')">Start Motor</button>
    <button class="off-btn" onclick="controlMotor('off')">Stop Motor</button>
    <button class="off-btn reset-btn" onclick="resetConnection()">Reset Connection</button>

    <div class="progress-bar">
      <progress id="progressBar" value="0" max="100" style="display: none;"></progress>
      <div class="time-display" id="timeDisplay" style="display:none;">Time: 00:00</div>
    </div>

    <div class="final-message" id="finalMessage" style="display:none;"></div>
  </div>

  <script>
    let esp32IP = "";
    const subnetBase = "192.168.1.";
    const totalIPsToScan = 50;
    const scanLog = document.getElementById("scanLog");
    let progressInterval = null;
    let elapsedSeconds = 0;
    let scanTimeout = null;
    let found = false;
    let redirectInitiated = false;

    const storedIP = localStorage.getItem("esp32IP");
    if (storedIP) {
      esp32IP = storedIP;
      document.getElementById("motorStatus").innerText = `‚úÖ ESP32 IP loaded from memory: ${esp32IP}`;
    } else {
      setTimeout(scanForESP32, 500);
    }

    function scanForESP32() {
      let i = 1;

      function scanNextIP() {
  if (found || i > totalIPsToScan) {
    if (!found) {
      document.getElementById("motorStatus").innerText = "‚ùå ESP32 not found in subnet.";
      scanLog.innerHTML = "Please ensure ESP32 is connected and in the 192.168.1.x network.";
    }
    return;
  }

  const testIP = subnetBase + i;
  logIP(testIP);

  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 2000); // ‚è±Ô∏è 2-second timeout

  fetch(`http://${testIP}/check`, { signal: controller.signal })
    .then(() => {
      // Double-check with a second fetch for content validation
      return fetch(`http://${testIP}/check`);
    })
    .then(response => response.text())
    .then(text => {
      clearTimeout(timeout); // ‚úÖ clear the timeout if successful
      if (text.includes("ESP32_OK")) {
        found = true;
        esp32IP = `http://${testIP}`;
        localStorage.setItem("esp32IP", esp32IP);
        document.getElementById("motorStatus").innerText = `‚úÖ ESP32 Found at: ${esp32IP}`;
        stopScanning();
      }
    })
    .catch(() => {
      clearTimeout(timeout); // ‚ùå clear on fail or abort
    });

  i++;
  if (!found && i <= totalIPsToScan) {
    scanTimeout = setTimeout(scanNextIP, 250); // shorter delay for faster scanning
  }
}


      scanNextIP();
    }

    function logIP(ip) {
      scanLog.innerHTML = `Scanning ${ip}...`;
    }

    function stopScanning() {
      if (scanTimeout) clearTimeout(scanTimeout);
      scanLog.innerHTML = `Scanning completed. ESP32 found at: ${esp32IP}`;
    }

    function controlMotor(state) {
      if (!esp32IP) return alert("ESP32 not found yet!");

      fetch(`${esp32IP}/motor/${state}`)
        .then(response => response.text())
        .then(() => {
          document.getElementById("motorStatus").innerHTML =
            `Motor Status: <span style="color:${state === 'on' ? 'green' : 'red'}">${state.toUpperCase()}</span>`;
          if (state === 'on') startMotorAndServoRuntime();
          else stopProgressBar();
        })
        .catch(error => {
          console.error("Error:", error);
          document.getElementById("motorStatus").innerText = "‚ùå Error contacting ESP32.";
        });
    }

    function startMotorAndServoRuntime() {
      const progress = document.getElementById("progressBar");
      const timeDisplay = document.getElementById("timeDisplay");
      const finalMessage = document.getElementById("finalMessage");

      progress.style.display = 'block';
      timeDisplay.style.display = 'block';
      finalMessage.style.display = 'none';

      progress.value = 0;
      elapsedSeconds = 0;

      progressInterval = setInterval(() => {
        elapsedSeconds++;
        progress.value = (elapsedSeconds / 180) * 100;
        updateTimeDisplay();

        if (elapsedSeconds > 10 && elapsedSeconds <= 180 && (elapsedSeconds - 10) % 15 === 0) {
          const isOpenCycle = Math.floor((elapsedSeconds - 10) / 15) % 2 === 0;
          const action = isOpenCycle ? "open" : "close";
          fetch(`${esp32IP}/servo/${action}`).then(() => console.log(`Servo ${action}`));
        }


        if (elapsedSeconds >= 180 && !redirectInitiated) {
          redirectInitiated = true;
          clearInterval(progressInterval);

          fetch(`${esp32IP}/servo/close`)
            .then(() => {
              finalMessage.innerText = "Servo Cycle Complete. Servo Closed.";
            })
            .catch(err => {
              console.error("Final servo close failed:", err);
              finalMessage.innerText = "‚ö†Ô∏è Failed to close servo.";
            })
            .finally(() => {
              progress.style.display = 'none';
              timeDisplay.style.display = 'none';
              finalMessage.style.display = 'block';
              setTimeout(() => {
                window.location.href = "air-drying.html";
              }, 2000);
            });
        }
      }, 1000);
    }

    function stopProgressBar() {
      clearInterval(progressInterval);
      document.getElementById("progressBar").style.display = 'none';
      document.getElementById("timeDisplay").style.display = 'none';
    }

    function updateTimeDisplay() {
      const minutes = Math.floor(elapsedSeconds / 60);
      const seconds = elapsedSeconds % 60;
      document.getElementById('timeDisplay').innerText = `Time: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function resetConnection() {
      localStorage.removeItem("esp32IP");
      esp32IP = "";
      found = false;
      document.getElementById("motorStatus").innerText = "üîÅ Resetting connection. Rescanning...";
      scanLog.innerHTML = "";
      scanForESP32();
    }

    function goBack() {
      window.location.href = "index.html";
    }
  </script>
</body>
</html>
